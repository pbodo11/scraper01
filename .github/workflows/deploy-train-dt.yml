name: Deploy train-dt (CF Gen2 + Cloud Scheduler)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloud_function/train-dt/**'
      - '.github/workflows/deploy-train-dt.yml'

permissions:
  contents: read
  id-token: write

env:
  # --------------------------------------------------------
  # âœ… HARDCODED CONFIGURATION (To Bypass GitHub Variable Bugs)
  # --------------------------------------------------------
  PROJECT_ID: 'project-3e08ac44-4e19-4725-85a'
  REGION: 'us-east1'
  BUCKET_NAME: 'data-pbodo-01'
  
  # FUNCTION CONFIG
  FUNCTION_NAME: train-dt
  FUNCTION_DIR: cloud_function/train-dt
  ENTRY_POINT: train_dt_http
  RUNTIME: python312
  TIMEOUT_SECONDS: "900"
  MEMORY: "2Gi"
  
  # APP DATA
  DATA_KEY: "structured/datasets/listings_master.csv"
  OUTPUT_PREFIX: "structured/preds"

  # SERVICE ACCOUNTS (Hardcoded to kill "Ghost Spaces")
  RUNTIME_SA: 'cf-runtime@project-3e08ac44-4e19-4725-85a.iam.gserviceaccount.com'
  DEPLOYER_SA: 'cf-deployer@project-3e08ac44-4e19-4725-85a.iam.gserviceaccount.com'
  WORKLOAD_IDENTITY_PROVIDER: 'projects/82424024776/locations/global/workloadIdentityPools/github-pool/providers/gh-actions'

  # SCHEDULER CONFIG
  SCHEDULE_BODY: '{"dry_run":true}'
  CRON_EXPR: "20 * * * *"   # Run at minute 20 of every hour

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # STEP 1: AUTHENTICATION (Uses Hardcoded Env Vars)
      # ----------------------------------------------------------------
      - name: Auth (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SA }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Verify source
        shell: bash
        run: |
          set -euo pipefail
          ls -la "${FUNCTION_DIR}"
          test -f "${FUNCTION_DIR}/main.py"
          test -f "${FUNCTION_DIR}/requirements.txt"

      # ----------------------------------------------------------------
      # STEP 2: DEPLOY CLOUD FUNCTION
      # ----------------------------------------------------------------
      - name: Deploy Cloud Function (Gen2)
        shell: bash
        run: |
          set -euo pipefail
          
          # Deploy using hardcoded environment variables
          gcloud functions deploy "${FUNCTION_NAME}" \
            --gen2 \
            --region="${REGION}" \
            --runtime="${RUNTIME}" \
            --source="${FUNCTION_DIR}" \
            --entry-point="${ENTRY_POINT}" \
            --trigger-http \
            --no-allow-unauthenticated \
            --timeout="${TIMEOUT_SECONDS}" \
            --memory="${MEMORY}" \
            --service-account="${RUNTIME_SA}" \
            --set-env-vars="PROJECT_ID=${PROJECT_ID},GCS_BUCKET=${BUCKET_NAME},DATA_KEY=${DATA_KEY},OUTPUT_PREFIX=${OUTPUT_PREFIX}"

      # ----------------------------------------------------------------
      # STEP 3: GRANT PERMISSIONS
      # ----------------------------------------------------------------
      - name: Grant invoker to deployer & runtime SAs
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Granting invoker rights to Deployer: ${DEPLOYER_SA}"
          gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
            --gen2 --region "${REGION}" \
            --member="serviceAccount:${DEPLOYER_SA}"
          
          echo "Granting invoker rights to Runtime: ${RUNTIME_SA}"
          gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
            --gen2 --region "${REGION}" \
            --member="serviceAccount:${RUNTIME_SA}"

      - name: Get Function URL
        id: cfurl
        shell: bash
        run: |
          set -euo pipefail
          URL=$(gcloud functions describe "${FUNCTION_NAME}" --gen2 --region "${REGION}" --format='value(serviceConfig.uri)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "Function URL: ${URL}"

      # ----------------------------------------------------------------
      # STEP 4: SETUP CLOUD SCHEDULER
      # ----------------------------------------------------------------
      - name: Ensure Scheduler API enabled
        shell: bash
        run: |
          gcloud services enable cloudscheduler.googleapis.com

      - name: Bootstrap IAM for Scheduler OIDC (runtime SA)
        shell: bash
        run: |
          set -euo pipefail
          
          PROJECT_NUMBER="$(gcloud projects describe "${PROJECT_ID}" --format='value(projectNumber)')"
          SCHED_AGENT="service-${PROJECT_NUMBER}@gcp-sa-cloudscheduler.iam.gserviceaccount.com"
          
          echo "Scheduler Agent: ${SCHED_AGENT}"

          # 1) Allow Scheduler to create tokens as the Runtime SA
          gcloud iam service-accounts add-iam-policy-binding "${RUNTIME_SA}" \
            --member="serviceAccount:${SCHED_AGENT}" \
            --role="roles/iam.serviceAccountTokenCreator" || true

          # 2) Allow Deployer to act as Runtime SA
          gcloud iam service-accounts add-iam-policy-binding "${RUNTIME_SA}" \
            --member="serviceAccount:${DEPLOYER_SA}" \
            --role="roles/iam.serviceAccountUser" || true

      - name: Create/Update Cloud Scheduler job
        shell: bash
        run: |
          set -euo pipefail
          JOB_NAME="${FUNCTION_NAME}-hourly"
          URL="${{ steps.cfurl.outputs.url }}"
          
          if [[ -z "${URL}" ]]; then
             echo "Error: Function URL is empty."
             exit 1
          fi

          echo "Creating/Updating Scheduler Job: ${JOB_NAME}"

          # Check if job exists
          if gcloud scheduler jobs describe "$JOB_NAME" --location="${REGION}" >/dev/null 2>&1; then
            # UPDATE
            gcloud scheduler jobs update http "$JOB_NAME" \
              --location="${REGION}" \
              --schedule="${CRON_EXPR}" \
              --time-zone="America/New_York" \
              --uri="${URL}" \
              --http-method=POST \
              --message-body='${{ env.SCHEDULE_BODY }}' \
              --attempt-deadline="${TIMEOUT_SECONDS}s" \
              --oidc-service-account-email="${RUNTIME_SA}" \
              --oidc-token-audience="${URL}"
          else
            # CREATE
            gcloud scheduler jobs create http "$JOB_NAME" \
              --location="${REGION}" \
              --schedule="${CRON_EXPR}" \
              --time-zone="America/New_York" \
              --uri="${URL}" \
              --http-method=POST \
              --message-body='${{ env.SCHEDULE_BODY }}' \
              --attempt-deadline="${TIMEOUT_SECONDS}s" \
              --oidc-service-account-email="${RUNTIME_SA}" \
              --oidc-token-audience="${URL}"
          fi

      # ----------------------------------------------------------------
      # STEP 5: SMOKE TEST
      # ----------------------------------------------------------------
      - name: Mint ID token for smoke
        id: auth-smoke
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SA }}
          token_format: "id_token"
          id_token_audience: ${{ steps.cfurl.outputs.url }}
          id_token_include_email: true

      - name: Smoke invoke (authenticated)
        shell: bash
        run: |
          set -euo pipefail
          URL="${{ steps.cfurl.outputs.url }}"
          TOKEN="${{ steps.auth-smoke.outputs.id_token }}"
          
          echo "Triggering Smoke Test..."
          curl -i -sS -X POST "$URL" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d '${{ env.SCHEDULE_BODY }}' || true
