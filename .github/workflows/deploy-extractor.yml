name: Deploy Extractor (CF Gen2)

on:
  push:
    branches:
      - main
    paths:
      - 'cloud_function/extractor-per-listing/**'
      - '.github/workflows/deploy-extractor.yml'

permissions:
  contents: read
  id-token: write

env:
  # --------------------------------------------------------
  # âœ… HARDCODED CONFIGURATION (Corrected Path)
  # --------------------------------------------------------
  PROJECT_ID: 'project-3e08ac44-4e19-4725-85a'
  REGION: 'us-east1'
  BUCKET_NAME: 'data-pbodo-01'
  
  # FUNCTION CONFIG
  # âœ… UPDATED: Matching your actual folder name
  FUNCTION_NAME: 'extractor-per-listing'
  FUNCTION_DIR: 'cloud_function/extractor-per-listing'
  ENTRY_POINT: 'extractor_per_listing'
  RUNTIME: 'python312'
  TIMEOUT_SECONDS: '300'
  MEMORY: '1Gi'

  # SERVICE ACCOUNTS (Hardcoded to prevent errors)
  RUNTIME_SA: 'cf-runtime@project-3e08ac44-4e19-4725-85a.iam.gserviceaccount.com'
  DEPLOYER_SA: 'cf-deployer@project-3e08ac44-4e19-4725-85a.iam.gserviceaccount.com'
  WORKLOAD_IDENTITY_PROVIDER: 'projects/82424024776/locations/global/workloadIdentityPools/github-pool/providers/gh-actions'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # STEP 1: AUTHENTICATION
      # ----------------------------------------------------------------
      - name: Auth (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SA }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # ----------------------------------------------------------------
      # STEP 2: VERIFY & DEPLOY
      # ----------------------------------------------------------------
      - name: Verify source
        shell: bash
        run: |
          ls -la "${FUNCTION_DIR}"
          test -f "${FUNCTION_DIR}/main.py"
          test -f "${FUNCTION_DIR}/requirements.txt"

      - name: Deploy Cloud Function (Gen2)
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ðŸš€ Deploying function from: ${FUNCTION_DIR}"
          
          gcloud functions deploy "${FUNCTION_NAME}" \
            --gen2 \
            --region="${REGION}" \
            --runtime="${RUNTIME}" \
            --source="${FUNCTION_DIR}" \
            --entry-point="${ENTRY_POINT}" \
            --trigger-http \
            --no-allow-unauthenticated \
            --timeout="${TIMEOUT_SECONDS}" \
            --memory="${MEMORY}" \
            --service-account="${RUNTIME_SA}" \
            --set-env-vars="PROJECT_ID=${PROJECT_ID},GCS_BUCKET=${BUCKET_NAME}"

      # ----------------------------------------------------------------
      # STEP 3: GRANT PERMISSIONS
      # ----------------------------------------------------------------
      - name: Grant invoker to deployer & runtime SAs
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Granting invoker rights to Deployer..."
          gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
            --gen2 --region "${REGION}" \
            --member="serviceAccount:${DEPLOYER_SA}"
          
          echo "Granting invoker rights to Runtime..."
          gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
            --gen2 --region "${REGION}" \
            --member="serviceAccount:${RUNTIME_SA}"

      - name: Get Function URL
        id: cfurl
        shell: bash
        run: |
          URL=$(gcloud functions describe "${FUNCTION_NAME}" --gen2 --region "${REGION}" --format='value(serviceConfig.uri)')
          echo "Function URL: ${URL}"
